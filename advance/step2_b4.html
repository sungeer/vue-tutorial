<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>步骤4 最小化：localStorage 持久化</title>
    <style>
        [v-cloak]{display:none}
        body{font-family:system-ui;margin:20px}
        table{border-collapse:collapse;width:480px;max-width:100%}
        th,td{border:1px solid #ccc;padding:8px;text-align:left}
        .row{margin:8px 0}
        label{display:inline-block;width:80px}
        input{padding:6px 8px}
        button{padding:6px 10px}
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <h1>{{ title }}</h1>

        <table>
            <thead><tr><th>名称</th><th>血量</th></tr></thead>
            <tbody>
                <tr v-for="h in heroes" :key="h.id">
                    <td>{{ h.name }}</td>
                    <td>{{ h.hp }}</td>
                </tr>
            </tbody>
        </table>

        <div class="row">
            <label>名称</label>
            <input type="text" :value="addForm.name" @input="onAddNameInput">
        </div>
        <div class="row">
            <label>血量</label>
            <input type="number" min="0" :value="addForm.hp" @input="onAddHpInput">
        </div>
        <button type="button" @click="submitAdd">增加</button>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
        (function () {
            var ref = Vue.ref;
            var reactive = Vue.reactive;

            // 新增：localStorage key
            var LS_KEY = 'hero-manager.step4.heroes';
            // 新增：加载与保存函数
            function loadFromLocalStorage() {
                try {
                    var text = window.localStorage.getItem(LS_KEY);
                    if (!text) return null;
                    var parsed = JSON.parse(text);
                    if (!Array.isArray(parsed)) return null;
                    return parsed;
                } catch (e) { return null; }
            }
            function saveToLocalStorage(list) {
                try {
                    window.localStorage.setItem(LS_KEY, JSON.stringify(list));
                } catch (e) { /* 忽略 */ }
            }

            // 纯函数区（保持与步骤4一致）
            function createEmptyHero() {
                return { id: 0, name: '', hp: '' };
            }
            function prepareHeroName(name, id) {
                var s = String(name == null ? '' : name).trim();
                if (s.length > 0) return s;
                return 'Hero#' + id;
            }
            function prepareHeroHp(hp) {
                var n = Number(hp);
                if (Number.isFinite(n) && n >= 0) return Math.floor(n);
                return 0;
            }
            function addHeroToList(list, nextId, draft) {
                var id = nextId + 1;
                var newHero = {
                    id: id,
                    name: prepareHeroName(draft.name, id),
                    hp: prepareHeroHp(draft.hp)
                };
                var copy = list.slice();
                copy.push(newHero);
                return { nextId: id, list: copy };
            }

            var app = Vue.createApp({
                setup: function () {
                    var title = ref('英雄管理面板（步骤4：持久化版）');

                    // 改动：初始化 heroes 优先使用 localStorage
                    var fromLS = loadFromLocalStorage();
                    var heroes = ref(Array.isArray(fromLS) ? fromLS : [
                        { id: 1, name: '盖伦', hp: 318 },
                        { id: 2, name: '提莫', hp: 320 }
                    ]);

                    // nextId 与步骤4相同（此处为常量 2，仅示例；也可动态根据 heroes 计算）
                    var nextId = ref((function () {
                        var maxId = 0; var i;
                        for (i=0;i<heroes.value.length;i=i+1) {
                            if (heroes.value[i].id > maxId) maxId = heroes.value[i].id;
                        }
                        return maxId;
                    })());

                    var addForm = reactive(createEmptyHero());

                    function onAddNameInput(e) { addForm.name = e.target.value; }
                    function onAddHpInput(e) { addForm.hp = e.target.value; }

                    function submitAdd() {
                        var result = addHeroToList(heroes.value, nextId.value, addForm);
                        heroes.value = result.list;
                        nextId.value = result.nextId;
                        Object.assign(addForm, createEmptyHero());
                        // 改动：提交后立即保存（最小化实现；也可用 watch 深度监听）
                        saveToLocalStorage(heroes.value);
                    }

                    return {
                        title: title,
                        heroes: heroes,
                        addForm: addForm,
                        onAddNameInput: onAddNameInput,
                        onAddHpInput: onAddHpInput,
                        submitAdd: submitAdd
                    };
                }
            });

            app.mount('#app');
        })();
    </script>
</body>
</html>