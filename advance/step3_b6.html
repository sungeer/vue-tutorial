<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>步骤6 最小化：组件化（列表 + 编辑表单）</title>
    <style>
        [v-cloak]{display:none}
        body{font-family:system-ui;margin:20px}
        table{border-collapse:collapse;width:480px;max-width:100%}
        th,td{border:1px solid #ccc;padding:8px;text-align:left}
        .box{border:1px solid #ccc;padding:12px;margin-top:12px}
        label{display:inline-block;width:80px}
        input{padding:6px 8px}
        button{padding:6px 10px}
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <h1>{{ title }}</h1>

        <!-- 列表子组件 -->
        <hero-list
            v-if="!isEditing"
            :heroes="heroes"
            @edit="startEditing"
        ></hero-list>

        <!-- 编辑表单子组件 -->
        <hero-edit-form
            v-else
            :model="editForm"
            @update:model="onUpdateEditForm"
            @cancel="cancelEditing"
        ></hero-edit-form>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
        (function () {
            var ref = Vue.ref;
            var reactive = Vue.reactive;
            var computed = Vue.computed;

            // 纯函数（与步骤6一致）
            function createEmptyHero() { return { id: 0, name: '', hp: '' }; }
            function findHeroIndexById(list, heroId) {
                var i; for (i=0;i<list.length;i=i+1){ if(list[i].id===heroId) return i; }
                return -1;
            }

            // 子组件：列表（最小化，仅支持编辑按钮）
            var HeroList = {
                name: 'HeroList',
                props: {
                    heroes: { type: Array, required: true }
                },
                template:
                    '<section>' +
                        '<table>' +
                            '<thead><tr><th>名称</th><th>血量</th><th>操作</th></tr></thead>' +
                            '<tbody>' +
                                '<tr v-for="h in heroes" :key="h.id">' +
                                    '<td>{{ h.name }}</td>' +
                                    '<td>{{ h.hp }}</td>' +
                                    '<td>' +
                                        '<button type="button" @click="$emit(\'edit\', h.id)">编辑</button>' +
                                    '</td>' +
                                '</tr>' +
                            '</tbody>' +
                        '</table>' +
                    '</section>'
            };

            // 子组件：编辑表单（最小化，受控模型 + emit 更新/取消）
            var HeroEditForm = {
                name: 'HeroEditForm',
                props: {
                    model: { type: Object, required: true } // { id, name, hp }
                },
                methods: {
                    onNameInput: function (e) {
                        this.$emit('update:model', Object.assign({}, this.model, { name: e.target.value }));
                    },
                    onHpInput: function (e) {
                        this.$emit('update:model', Object.assign({}, this.model, { hp: e.target.value }));
                    },
                    onCancel: function () {
                        this.$emit('cancel');
                    }
                },
                template:
                    '<section class="box">' +
                        '<div>' +
                            '<label>名称</label>' +
                            '<input type="text" :value="model.name" @input="onNameInput">' +
                        '</div>' +
                        '<div style="margin-top:8px">' +
                            '<label>血量</label>' +
                            '<input type="number" min="0" :value="model.hp" @input="onHpInput">' +
                        '</div>' +
                        '<div style="margin-top:8px">' +
                            '<button type="button" @click="onCancel">取消</button>' +
                        '</div>' +
                    '</section>'
            };

            var app = Vue.createApp({
                components: {
                    'hero-list': HeroList,
                    'hero-edit-form': HeroEditForm
                },
                setup: function () {
                    var title = ref('英雄管理面板（步骤6：组件化最小版）');
                    var heroes = ref([
                        { id: 1, name: '盖伦', hp: 318 },
                        { id: 2, name: '提莫', hp: 320 },
                        { id: 3, name: '安妮', hp: 419 }
                    ]);

                    var editingId = ref(null);
                    var editForm = reactive(createEmptyHero());

                    var isEditing = computed(function () {
                        return editingId.value !== null;
                    });

                    function startEditing(heroId) {
                        var i = findHeroIndexById(heroes.value, heroId);
                        if (i === -1) return;
                        var h = heroes.value[i];
                        editingId.value = h.id;
                        Object.assign(editForm, { id: h.id, name: h.name, hp: String(h.hp) });
                    }
                    function onUpdateEditForm(newModel) {
                        Object.assign(editForm, newModel);
                    }
                    function cancelEditing() {
                        editingId.value = null;
                        Object.assign(editForm, createEmptyHero());
                    }

                    return {
                        title: title,
                        heroes: heroes,
                        isEditing: isEditing,
                        editForm: editForm,
                        startEditing: startEditing,
                        onUpdateEditForm: onUpdateEditForm,
                        cancelEditing: cancelEditing
                    };
                }
            });

            app.mount('#app');
        })();
    </script>
</body>
</html>