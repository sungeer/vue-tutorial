<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>步骤4：纯函数区</title>
    <style>
        [v-cloak]{display:none}
        body{font-family:system-ui;margin:20px}
        table{border-collapse:collapse;width:480px;max-width:100%}
        th,td{border:1px solid #ccc;padding:8px;text-align:left}
        .row{margin:8px 0}
        label{display:inline-block;width:80px}
    </style>
</head>
<body>
<div id="app" v-cloak>
    <h1>{{ title }}</h1>

    <table>
        <thead>
        <tr>
            <th>名称</th>
            <th>血量</th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="h in heroes" v-bind:key="h.id">
            <td>{{ h.name }}</td>
            <td>{{ h.hp }}</td>
        </tr>
        </tbody>
    </table>

    <div class="row">
        <label>名称</label>
        <input type="text" v-bind:value="addForm.name" v-on:input="onAddNameInput">
    </div>
    <div class="row">
        <label>血量</label>
        <input type="number" min="0" v-bind:value="addForm.hp" v-on:input="onAddHpInput">
    </div>
    <button type="button" v-on:click="submitAdd">增加</button>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script>
    (function () {
        var ref = Vue.ref;
        var reactive = Vue.reactive;

        function createEmptyHero() {
            return { id: 0, name: '', hp: '' };
        }

        function prepareHeroName(name, id) {
            var s = String(name == null ? '' : name).trim();
            if (s.length > 0) return s;
            return 'Hero#' + id;
        }

        function prepareHeroHp(hp) {
            var n = Number(hp);
            if (Number.isFinite(n) && n >= 0) return Math.floor(n);
            return 0;
        }

        function addHeroToList(list, nextId, draft) {
            var id = nextId + 1;
            var newHero = {
                id: id,
                name: prepareHeroName(draft.name, id),
                hp: prepareHeroHp(draft.hp)
            };
            var copy = list.slice();
            copy.push(newHero);
            return { nextId: id, list: copy };
        }

        var app = Vue.createApp({
            setup: function () {
                var title = ref('英雄管理面板（步骤4）');
                var heroes = ref([
                    { id: 1, name: '盖伦', hp: 318 },
                    { id: 2, name: '提莫', hp: 320 }
                ]);
                var nextId = ref(2);
                var addForm = reactive(createEmptyHero());  // 将 对象 变成 响应式 对象

                function onAddNameInput(e) {
                    addForm.name = e.target.value;
                }

                function onAddHpInput(e) {
                    addForm.hp = e.target.value;
                }

                function submitAdd() {
                    var result = addHeroToList(heroes.value, nextId.value, addForm);
                    heroes.value = result.list;
                    nextId.value = result.nextId;
                    Object.assign(addForm, createEmptyHero());
                }

                return {
                    title: title,
                    heroes: heroes,
                    addForm: addForm,
                    onAddNameInput: onAddNameInput,
                    onAddHpInput: onAddHpInput,
                    submitAdd: submitAdd
                };
            }
        });

        app.mount('#app');
    })();
</script>
</body>
</html>